<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TUBS BOT</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <div id="grid">

    <!-- TOP-LEFT: Stacked Panels -->
    <div class="panel-stack" id="stack-tl">

      <!-- System Vitals -->
      <div class="panel stagger-1 collapsed" id="panel-tl">
        <div class="panel-title">
          System Vitals
          <span class="dot red header-dot" id="header-conn-dot"></span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Connection</span>
          <span class="stat-value" id="stat-conn"><span class="dot red" id="conn-dot"></span>Offline</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Uptime</span>
          <span class="stat-value" id="stat-uptime">00:00:00</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Awake Since</span>
          <span class="stat-value" id="stat-awake">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Model</span>
          <span class="stat-value" id="stat-model">—</span>
        </div>
      </div>

      <!-- Input Status (Moved from TR) -->
      <div class="panel stagger-2 collapsed" id="panel-input">
        <div class="panel-title">Input Status</div>
        <div class="stat-row">
          <span class="stat-label">Mic Active</span>
          <span class="stat-value" id="stat-mic">Off</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Volume</span>
          <span class="stat-value">
            <div class="volume-bar-container">
              <div class="volume-bar-fill" id="stat-vol"></div>
            </div>
          </span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Input Source</span>
          <span class="stat-value" id="stat-input-src">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Last Heard</span>
          <span class="stat-value" id="stat-last-heard">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">STT Confidence</span>
          <span class="stat-value" id="stat-stt">—</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">State</span>
          <span class="stat-value" id="stat-listen-state">Idle</span>
        </div>
        <div class="stat-row" style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(60,70,110,0.2);">
          <span class="stat-label">Always On</span>
          <label class="toggle-switch">
            <input type="checkbox" id="vad-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Noise Gate <span id="noise-gate-val">0.008</span></span>
          <input type="range" id="noise-gate" min="0" max="0.06" step="0.001" value="0.008" class="mini-range">
        </div>
        <div class="stat-row">
          <span class="stat-label">Camera</span>
          <label class="toggle-switch">
            <input type="checkbox" id="camera-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Fullscreen</span>
          <label class="toggle-switch">
            <input type="checkbox" id="fullscreen-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Face Render</span>
          <div class="face-render-controls">
            <select id="face-render-mode" class="mini-select">
              <option value="css">CSS</option>
              <option value="svg">SVG Beta</option>
            </select>
            <span id="face-render-active" class="mini-pill">CSS</span>
          </div>
        </div>
        <div class="stat-row" id="detect-delay-row" style="display:none;">
          <span class="stat-label">Detect <span id="detect-delay-val">auto</span></span>
          <input type="range" id="detect-delay" min="0" max="5000" step="100" value="0" class="mini-range">
        </div>
        <div class="stat-row">
          <span class="stat-label">Voice</span>
          <select id="tts-voice" class="mini-select">
            <optgroup label="American Female">
              <option value="af_heart">Heart</option>
              <option value="af_alloy">Alloy</option>
              <option value="af_aoede">Aoede</option>
              <option value="af_bella">Bella</option>
              <option value="af_jessica">Jessica</option>
              <option value="af_kore">Kore</option>
              <option value="af_nicole">Nicole</option>
              <option value="af_nova">Nova</option>
              <option value="af_river">River</option>
              <option value="af_sarah">Sarah</option>
              <option value="af_sky">Sky</option>
            </optgroup>
            <optgroup label="American Male">
              <option value="am_adam">Adam</option>
              <option value="am_echo">Echo</option>
              <option value="am_eric">Eric</option>
              <option value="am_fenrir">Fenrir</option>
              <option value="am_liam">Liam</option>
              <option value="am_michael">Michael</option>
              <option value="am_onyx">Onyx</option>
              <option value="am_puck">Puck</option>
              <option value="am_santa">Santa</option>
            </optgroup>
            <optgroup label="British Female">
              <option value="bf_alice">Alice</option>
              <option value="bf_emma">Emma</option>
              <option value="bf_isabella">Isabella</option>
              <option value="bf_lily">Lily</option>
            </optgroup>
            <optgroup label="British Male">
              <option value="bm_daniel">Daniel</option>
              <option value="bm_fable">Fable</option>
              <option value="bm_george">George</option>
              <option value="bm_lewis">Lewis</option>
            </optgroup>
            <optgroup label="Japanese">
              <option value="jf_alpha">Alpha (F)</option>
              <option value="jf_gongitsune">Gongitsune (F)</option>
              <option value="jf_nezumi">Nezumi (F)</option>
              <option value="jf_tebukuro">Tebukuro (F)</option>
              <option value="jm_kumo">Kumo (M)</option>
            </optgroup>
            <optgroup label="Other">
              <option value="ef_dora">Dora ES (F)</option>
              <option value="em_alex">Alex ES (M)</option>
              <option value="em_santa">Santa ES (M)</option>
              <option value="ff_siwis">Siwis FR (F)</option>
              <option value="hf_alpha">Alpha HI (F)</option>
              <option value="hf_beta">Beta HI (F)</option>
              <option value="hm_omega">Omega HI (M)</option>
              <option value="hm_psi">Psi HI (M)</option>
              <option value="if_sara">Sara IT (F)</option>
              <option value="im_nicola">Nicola IT (M)</option>
              <option value="pf_dora">Dora PT (F)</option>
              <option value="pm_alex">Alex PT (M)</option>
              <option value="pm_santa">Santa PT (M)</option>
              <option value="zf_xiaobei">Xiaobei ZH (F)</option>
              <option value="zf_xiaoni">Xiaoni ZH (F)</option>
              <option value="zf_xiaoxiao">Xiaoxiao ZH (F)</option>
              <option value="zf_xiaoyi">Xiaoyi ZH (F)</option>
              <option value="zm_yunjian">Yunjian ZH (M)</option>
              <option value="zm_yunxi">Yunxi ZH (M)</option>
              <option value="zm_yunxia">Yunxia ZH (M)</option>
              <option value="zm_yunyang">Yunyang ZH (M)</option>
            </optgroup>
          </select>
        </div>
        <div class="stat-row" style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(60,70,110,0.2);">
          <span class="stat-label">Sleep <span id="sleep-timeout-val">10s</span></span>
          <input type="range" id="sleep-timeout" min="5" max="600" step="5" value="10" class="mini-range">
        </div>
      </div>

    </div>

    <!-- CENTER: Face -->
    <div id="center">
      <div id="face">
        <div class="eye left"></div>
        <div class="eye right"></div>
        <div id="mouth"></div>
        <div id="zzz-anchor">
          <span class="zzz">z</span>
          <span class="zzz">z</span>
          <span class="zzz">z</span>
        </div>
      </div>

      <div id="loading-bar">
        <div class="fill"></div>
      </div>
      <div id="waveform-container"></div>
      <div id="ptt-indicator">Hold Space to Talk</div>
      <div id="speech-bubble"></div>
      <div id="subtitle"></div>
      <div id="donation-card" class="hidden">
        <div class="donation-title">"Wheels for Tubs" Fund</div>
        <img id="donation-qr" alt="Venmo donation QR code" />
        <div id="donation-handle"></div>
      </div>
    </div>



    <!-- BOTTOM-LEFT: Chat Log -->
    <div class="panel stagger-3 collapsed" id="panel-bl">
      <div class="panel-title">Chat Log <span id="verbosity-toggle"
          style="margin-left:8px;font-size:10px;font-weight:600;cursor:pointer;color:var(--accent);letter-spacing:0.05em">ALL</span><span
          style="margin-left:auto;font-weight:400;color:var(--text-dim)" id="turn-counter">0 turns</span></div>
      <div id="chat-log"></div>
      <div id="panel-bl-resize"></div>
    </div>

    <!-- BOTTOM-RIGHT: Bot Stats -->
    <div class="panel stagger-4 collapsed" id="panel-br">
      <div class="panel-title">Bot Stats</div>
      <div class="stat-row">
        <span class="stat-label">Response Time</span>
        <span class="stat-value" id="stat-resp-time">— ms</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Tokens In</span>
        <span class="stat-value" id="stat-tok-in">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Tokens Out</span>
        <span class="stat-value" id="stat-tok-out">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Queue Depth</span>
        <span class="stat-value" id="stat-queue">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Expression</span>
        <span class="stat-value" id="stat-expression">IDLE</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Session Cost</span>
        <span class="stat-value" id="stat-cost">$0.00</span>
      </div>
    </div>

    <!-- Camera PIP -->
    <div id="camera-pip" class="hidden">
      <div class="pip-resize-handle pip-resize-n"></div>
      <div class="pip-resize-handle pip-resize-w"></div>
      <div class="pip-resize-handle pip-resize-nw"></div>
      <div id="camera-pip-header">Camera</div>
      <video id="camera-feed" autoplay playsinline muted></video>
      <canvas id="camera-overlay"></canvas>
      <div id="camera-status"></div>
      <div id="presence-badge"></div>

      <!-- Enrollment Overlay -->
      <div id="enroll-overlay" class="hidden">
        <div id="enroll-status">Capturing samples...</div>
        <div id="enroll-instruction"></div>
        <div id="enroll-strip"></div>
        <div id="enroll-actions" class="hidden">
          <button id="enroll-cancel" class="btn-cancel">Discard All</button>
          <button id="enroll-save" class="btn-save">Save Face</button>
        </div>
      </div>
    </div>

    <!-- Face Detection Debug Panel -->
    <div id="face-debug" class="hidden">
      <div id="face-debug-header">Face Debug <span id="face-debug-close">✕</span></div>
      <div id="face-debug-body">
        <div id="face-debug-frame">
          <canvas id="face-debug-canvas"></canvas>
        </div>
        <div id="face-debug-info">
          <div class="debug-row"><span class="debug-label">Interval</span><span id="dbg-interval">—</span></div>
          <div class="debug-row"><span class="debug-label">Inference</span><span id="dbg-inference">—</span></div>
          <div class="debug-row"><span class="debug-label">Faces</span><span id="dbg-faces">0</span></div>
          <div class="debug-row"><span class="debug-label">Library</span><span id="dbg-library">0</span></div>
        </div>
        <div id="face-debug-detections"></div>
        <div id="face-library-section">
          <div id="face-library-header">Face Library <span id="face-library-refresh" title="Refresh">↻</span></div>
          <div id="face-library-list"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- CDN deps (regular scripts, set globals) -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.7/dist/bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>

  <!-- Single module entry point -->
  <script type="module" src="js/main.js"></script>
</body>

</html>
