<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TUBS BOT</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <div id="grid">

    <!-- TOP-LEFT: Stacked Panels -->
    <div class="panel-stack" id="stack-tl">

      <!-- System Vitals -->
      <div class="panel stagger-1 collapsed" id="panel-tl">
        <div class="panel-title">
          System Vitals
          <span class="dot red header-dot" id="header-conn-dot"></span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Connection</span>
          <span class="stat-value" id="stat-conn"><span class="dot red" id="conn-dot"></span>Offline</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Uptime</span>
          <span class="stat-value" id="stat-uptime">00:00:00</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Awake Since</span>
          <span class="stat-value" id="stat-awake">‚Äî</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Model</span>
          <span class="stat-value" id="stat-model">‚Äî</span>
        </div>
        <div class="stat-row" style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(60,70,110,0.2);">
          <span class="stat-label">Face Render</span>
          <div class="face-render-controls">
            <select id="face-render-mode" class="mini-select">
              <option value="css">CSS</option>
              <option value="svg">SVG Beta</option>
            </select>
            <span id="face-render-active" class="mini-pill">CSS</span>
          </div>
        </div>
        <div class="stat-row">
          <span class="stat-label">Face FX</span>
          <select id="face-render-quality" class="mini-select">
            <option value="high" selected>High</option>
            <option value="balanced">Balanced</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="stat-row">
          <span class="stat-label">Glitch FX</span>
          <label class="toggle-switch">
            <input type="checkbox" id="glitch-fx-toggle" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Glitch Backend</span>
          <span id="glitch-fx-backend" class="mini-pill">init</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Glitch Color</span>
          <input type="color" id="glitch-fx-color" value="#a855f7" class="mini-color">
        </div>
        <div class="stat-row" id="detect-delay-row" style="display:none;">
          <span class="stat-label">Detect <span id="detect-delay-val">auto</span></span>
          <input type="range" id="detect-delay" min="0" max="5000" step="100" value="0" class="mini-range">
        </div>
        <div class="stat-row">
          <span class="stat-label">Voice</span>
          <select id="tts-voice" class="mini-select">
            <optgroup label="American Female">
              <option value="af_heart">Heart</option>
              <option value="af_alloy">Alloy</option>
              <option value="af_aoede">Aoede</option>
              <option value="af_bella">Bella</option>
              <option value="af_jessica">Jessica</option>
              <option value="af_kore">Kore</option>
              <option value="af_nicole">Nicole</option>
              <option value="af_nova">Nova</option>
              <option value="af_river">River</option>
              <option value="af_sarah">Sarah</option>
              <option value="af_sky">Sky</option>
            </optgroup>
            <optgroup label="American Male">
              <option value="am_adam">Adam</option>
              <option value="am_echo">Echo</option>
              <option value="am_eric">Eric</option>
              <option value="am_fenrir">Fenrir</option>
              <option value="am_liam">Liam</option>
              <option value="am_michael">Michael</option>
              <option value="am_onyx">Onyx</option>
              <option value="am_puck">Puck</option>
              <option value="am_santa">Santa</option>
            </optgroup>
            <optgroup label="British Female">
              <option value="bf_alice">Alice</option>
              <option value="bf_emma">Emma</option>
              <option value="bf_isabella">Isabella</option>
              <option value="bf_lily">Lily</option>
            </optgroup>
            <optgroup label="British Male">
              <option value="bm_daniel">Daniel</option>
              <option value="bm_fable">Fable</option>
              <option value="bm_george">George</option>
              <option value="bm_lewis">Lewis</option>
            </optgroup>
            <optgroup label="Japanese">
              <option value="jf_alpha">Alpha (F)</option>
              <option value="jf_gongitsune">Gongitsune (F)</option>
              <option value="jf_nezumi">Nezumi (F)</option>
              <option value="jf_tebukuro">Tebukuro (F)</option>
              <option value="jm_kumo">Kumo (M)</option>
            </optgroup>
            <optgroup label="Other">
              <option value="ef_dora">Dora ES (F)</option>
              <option value="em_alex">Alex ES (M)</option>
              <option value="em_santa">Santa ES (M)</option>
              <option value="ff_siwis">Siwis FR (F)</option>
              <option value="hf_alpha">Alpha HI (F)</option>
              <option value="hf_beta">Beta HI (F)</option>
              <option value="hm_omega">Omega HI (M)</option>
              <option value="hm_psi">Psi HI (M)</option>
              <option value="if_sara">Sara IT (F)</option>
              <option value="im_nicola">Nicola IT (M)</option>
              <option value="pf_dora">Dora PT (F)</option>
              <option value="pm_alex">Alex PT (M)</option>
              <option value="pm_santa">Santa PT (M)</option>
              <option value="zf_xiaobei">Xiaobei ZH (F)</option>
              <option value="zf_xiaoni">Xiaoni ZH (F)</option>
              <option value="zf_xiaoxiao">Xiaoxiao ZH (F)</option>
              <option value="zf_xiaoyi">Xiaoyi ZH (F)</option>
              <option value="zm_yunjian">Yunjian ZH (M)</option>
              <option value="zm_yunxi">Yunxi ZH (M)</option>
              <option value="zm_yunxia">Yunxia ZH (M)</option>
              <option value="zm_yunyang">Yunyang ZH (M)</option>
            </optgroup>
          </select>
        </div>
        <div class="stat-row" style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(60,70,110,0.2);">
          <span class="stat-label">Two Heads</span>
          <label class="toggle-switch">
            <input type="checkbox" id="dual-head-enabled">
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Head Mode</span>
          <select id="dual-head-mode" class="mini-select">
            <option value="off">Off</option>
            <option value="llm_directed">LLM</option>
            <option value="mirror">Mirror</option>
          </select>
        </div>
        <div class="stat-row">
          <span class="stat-label">Turn Policy</span>
          <select id="dual-head-turn-policy" class="mini-select">
            <option value="llm_order">LLM</option>
            <option value="main_first">Main First</option>
            <option value="small_first">Small First</option>
          </select>
        </div>
        <div class="stat-row">
          <span class="stat-label">Small Voice</span>
          <select id="secondary-tts-voice" class="mini-select"></select>
        </div>
        <div class="stat-row">
          <span class="stat-label">Small FX</span>
          <select id="secondary-render-quality" class="mini-select">
            <option value="high">High</option>
            <option value="balanced" selected>Balanced</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="stat-row">
          <span class="stat-label">Small Glitch</span>
          <input type="color" id="secondary-glitch-fx-color" value="#22d3ee" class="mini-color">
        </div>
        <div class="stat-row">
          <span class="stat-label">Small Subs</span>
          <label class="toggle-switch">
            <input type="checkbox" id="secondary-subtitle-enabled" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Small Gain <span id="secondary-audio-gain-val">1.00</span></span>
          <input type="range" id="secondary-audio-gain" min="0" max="1.2" step="0.05" value="1" class="mini-range">
        </div>
        <div class="stat-row">
          <span class="stat-label">Mini Window</span>
          <button id="open-mini-window" class="mini-btn">Open</button>
        </div>
        <div class="stat-row" style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(60,70,110,0.2);">
          <span class="stat-label">Sleep <span id="sleep-timeout-val">10s</span></span>
          <input type="range" id="sleep-timeout" min="5" max="600" step="5" value="10" class="mini-range">
        </div>
        <div class="stat-row" style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(60,70,110,0.2);">
          <span class="stat-label">Manual Beats</span>
          <button id="manual-beats-toggle" class="mini-btn" type="button">Open</button>
        </div>
        <div id="manual-beats-shell" class="manual-beats-shell">
          <div class="manual-beats-row">
            <span class="manual-mini-label">Mode</span>
            <select id="manual-beats-mode" class="mini-select">
              <option value="single">Single Beat</option>
              <option value="script">Script JSON</option>
            </select>
          </div>
          <div id="manual-single-fields" class="manual-fields-grid">
            <div class="manual-beats-row">
              <span class="manual-mini-label">Actor</span>
              <select id="manual-beat-actor" class="mini-select">
                <option value="main">Main</option>
                <option value="small">Small</option>
              </select>
            </div>
            <div class="manual-beats-row">
              <span class="manual-mini-label">Action</span>
              <select id="manual-beat-action" class="mini-select">
                <option value="speak">Speak</option>
                <option value="react">React</option>
                <option value="wait">Wait</option>
              </select>
            </div>
            <div class="manual-beats-row">
              <span class="manual-mini-label">Expression</span>
              <select id="manual-beat-expression" class="mini-select">
                <option value="">None</option>
                <option value="idle">Idle</option>
                <option value="listening">Listening</option>
                <option value="thinking">Thinking</option>
                <option value="smile">Smile</option>
                <option value="happy">Happy</option>
                <option value="love">Love</option>
                <option value="sad">Sad</option>
                <option value="crying">Crying</option>
                <option value="sleep">Sleep</option>
              </select>
            </div>
            <div class="manual-beats-row">
              <span class="manual-mini-label">Emoji</span>
              <select id="manual-beat-emoji" class="mini-select">
                <option value="">None</option>
                <option value="üôÇ">üôÇ</option>
                <option value="üòÑ">üòÑ</option>
                <option value="üòè">üòè</option>
                <option value="ü•∫">ü•∫</option>
                <option value="üò¢">üò¢</option>
                <option value="üò§">üò§</option>
                <option value="ü§ñ">ü§ñ</option>
                <option value="ü´∂">ü´∂</option>
              </select>
            </div>
            <div class="manual-beats-row">
              <span class="manual-mini-label">Delay ms</span>
              <input id="manual-beat-delay" class="manual-mini-input" type="number" min="120" max="8000" step="10"
                placeholder="auto">
            </div>
            <textarea id="manual-beat-text" class="manual-textarea"
              placeholder="Type beat text. Example: Happy Valentine's Day from Tubs."></textarea>
          </div>
          <div id="manual-script-fields" class="manual-script-wrap">
            <textarea id="manual-script-json" class="manual-textarea manual-script-textarea" spellcheck="false"
              placeholder='{"beats":[{"actor":"main","action":"speak","text":"Happy Valentine&apos;s Day","emotion":{"expression":"love","emoji":"ü´∂"}}]}'></textarea>
          </div>
          <div class="manual-beats-actions">
            <button id="manual-beats-send" class="mini-btn" type="button">Send</button>
            <button id="manual-beats-template" class="mini-btn" type="button">Valentine</button>
            <button id="manual-beats-clear" class="mini-btn" type="button">Clear</button>
          </div>
          <div id="manual-beats-status" class="manual-beats-status">Ready</div>
        </div>
      </div>

      <!-- Input Status (Moved from TR) -->
      <div class="panel stagger-2 collapsed" id="panel-input">
        <div class="panel-title">Input Status</div>
        <div class="stat-row">
          <span class="stat-label">Mic Active</span>
          <span class="stat-value" id="stat-mic">Off</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Volume</span>
          <span class="stat-value">
            <div class="volume-bar-container">
              <div class="volume-bar-fill" id="stat-vol"></div>
            </div>
          </span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Input Source</span>
          <span class="stat-value" id="stat-input-src">‚Äî</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Last Heard</span>
          <span class="stat-value" id="stat-last-heard">‚Äî</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">STT Confidence</span>
          <span class="stat-value" id="stat-stt">‚Äî</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">State</span>
          <span class="stat-value" id="stat-listen-state">Idle</span>
        </div>
        <div class="stat-row" style="margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(60,70,110,0.2);">
          <span class="stat-label">Always On</span>
          <label class="toggle-switch">
            <input type="checkbox" id="vad-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Mute</span>
          <label class="toggle-switch">
            <input type="checkbox" id="mute-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Ambient</span>
          <label class="toggle-switch">
            <input type="checkbox" id="ambient-audio-toggle" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Noise Gate <span id="noise-gate-val">0.008</span></span>
          <input type="range" id="noise-gate" min="0" max="0.06" step="0.001" value="0.008" class="mini-range">
        </div>
        <div class="stat-row">
          <span class="stat-label">Camera</span>
          <label class="toggle-switch">
            <input type="checkbox" id="camera-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div class="stat-row">
          <span class="stat-label">Fullscreen</span>
          <label class="toggle-switch">
            <input type="checkbox" id="fullscreen-toggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>

    </div>

    <!-- CENTER: Face -->
    <div id="center">
      <div id="face">
        <div class="eye left"></div>
        <div class="eye right"></div>
        <div id="mouth"></div>
        <div id="zzz-anchor">
          <span class="zzz">z</span>
          <span class="zzz">z</span>
          <span class="zzz">z</span>
        </div>
      </div>

      <div id="loading-bar">
        <div class="fill"></div>
      </div>
      <div id="waveform-container"></div>
      <div id="ptt-indicator">Hold Space to Talk</div>
      <div id="speech-bubble"></div>
      <div id="subtitle"></div>
      <div id="donation-card" class="hidden">
        <div class="donation-title">"Wheels for Tubs" Fund</div>
        <img id="donation-qr" alt="Venmo donation QR code" />
        <div id="donation-handle"></div>
      </div>
    </div>



    <!-- BOTTOM-LEFT: Chat Log -->
    <div class="panel stagger-3 collapsed" id="panel-bl">
      <div class="panel-title">Chat Log <span id="verbosity-toggle"
          style="margin-left:8px;font-size:10px;font-weight:600;cursor:pointer;color:var(--accent);letter-spacing:0.05em">ALL</span><span
          style="margin-left:auto;font-weight:400;color:var(--text-dim)" id="turn-counter">0 turns</span></div>
      <div id="chat-log"></div>
      <div id="panel-bl-resize"></div>
    </div>

    <!-- BOTTOM-RIGHT: Bot Stats -->
    <div class="panel stagger-4 collapsed" id="panel-br">
      <div class="panel-title">Bot Stats</div>
      <div class="stat-row">
        <span class="stat-label">Response Time</span>
        <span class="stat-value" id="stat-resp-time">‚Äî ms</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Tokens In</span>
        <span class="stat-value" id="stat-tok-in">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Tokens Out</span>
        <span class="stat-value" id="stat-tok-out">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Queue Depth</span>
        <span class="stat-value" id="stat-queue">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Expression</span>
        <span class="stat-value" id="stat-expression">IDLE</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Session Cost</span>
        <span class="stat-value" id="stat-cost">$0.00</span>
      </div>
    </div>

    <!-- Camera PIP -->
    <div id="camera-pip" class="hidden">
      <div id="camera-pip-header">Camera</div>

      <!-- Enrollment: instruction bar above video -->
      <div id="enroll-overlay" class="hidden">
        <div id="enroll-instruction"></div>
        <div id="enroll-status">Capturing samples...</div>
      </div>

      <!-- Video + canvas wrapper (overlay always aligned with video) -->
      <div id="camera-video-wrap">
        <video id="camera-feed" autoplay playsinline muted></video>
        <canvas id="camera-overlay"></canvas>
        <div id="camera-status"></div>
        <div id="presence-badge"></div>
        <!-- Enrollment: overlaid on video bottom -->
        <div id="enroll-strip"></div>
        <div id="enroll-actions" class="hidden">
          <button id="enroll-cancel" class="btn-cancel">Discard All</button>
          <button id="enroll-save" class="btn-save">Save Face</button>
        </div>
      </div>
    </div>

    <!-- Face Detection Debug Panel -->
    <div id="face-debug" class="hidden">
      <div id="face-debug-header">Face Debug <span id="face-debug-close">‚úï</span></div>
      <div id="face-debug-body">
        <div id="face-debug-frame">
          <canvas id="face-debug-canvas"></canvas>
        </div>
        <div id="face-debug-info">
          <div class="debug-row"><span class="debug-label">Interval</span><span id="dbg-interval">‚Äî</span></div>
          <div class="debug-row"><span class="debug-label">Inference</span><span id="dbg-inference">‚Äî</span></div>
          <div class="debug-row"><span class="debug-label">Faces</span><span id="dbg-faces">0</span></div>
          <div class="debug-row"><span class="debug-label">Library</span><span id="dbg-library">0</span></div>
        </div>
        <div id="face-debug-detections"></div>
        <div id="face-library-section">
          <div id="face-library-header">Face Library <span id="face-library-refresh" title="Refresh">‚Üª</span></div>
          <div id="face-library-list"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- CDN deps (regular scripts, set globals) -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.7/dist/bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stats.js@0.17.0/build/stats.min.js"></script>

  <!-- Single module entry point -->
  <script type="module" src="js/main.js"></script>
</body>

</html>
